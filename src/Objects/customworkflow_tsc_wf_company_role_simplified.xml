<?xml version="1.0" encoding="UTF-8"?>
<!-- SIMPLIFIED WORKFLOW - TSC Company Role Approval -->
<!-- Original: customworkflow_tsc_wf_company_role.xml -->
<workflow scriptid="customworkflow_tsc_wf_company_role">
  <name>TSC|WF|Company Role Approval</name>
  <description>Purchase Order approval workflow with company role hierarchy</description>
  <recordtypes>PURCHASEORDER</recordtypes>
  <releasestatus>RELEASED</releasestatus>
  <runasadmin>T</runasadmin>
  <keephistory>ALWAYS</keephistory>
  
  <!-- WORKFLOW CUSTOM FIELDS -->
  <workflowcustomfields>
    <field scriptid="custworkflow_tsc_emg008_approval_threshold" type="SELECT" 
           selectrecordtype="customrecord_tsc_approval_thresholds" label="Approval Threshold"/>
    <field scriptid="custworkflow_tsc_emg008_coo" type="SELECT" 
           selectrecordtype="customrecord_tsc_approver_config" label="COO"/>
    <field scriptid="custworkflow_tsc_emg008_cfo" type="SELECT" 
           selectrecordtype="customrecord_tsc_approver_config" label="CFO"/>
    <field scriptid="custworkflow_tsc_emg008_ceo" type="SELECT" 
           selectrecordtype="customrecord_tsc_approver_config" label="CEO"/>
  </workflowcustomfields>

  <!-- WORKFLOW STATES -->
  <workflowstates>
    
    <!-- STATE 1: INITIATE -->
    <workflowstate scriptid="workflowstate142" name="Initiate" position="643,63">
      <onentry>
        <setfield field="custbody_tsc_created_by" value="STDUSERUSER" type="FIELD"/>
      </onentry>
      <beforeload>
        <setdisplaytype field="custbody_tsc_created_by" displaytype="DISABLED"/>
        <setdisplaytype field="STDBODYAPPROVALSTATUS" displaytype="DISABLED"/>
        <setdisplaytype field="custbody_tsc_last_approver" displaytype="DISABLED"/>
        <setdisplaytype field="STDBODYNEXTAPPROVER" displaytype="DISABLED"/>
      </beforeload>
      <transitions>
        <transition to="workflowstate143" trigger="BEFORESUBMIT"/>
      </transitions>
    </workflowstate>

    <!-- STATE 2: DETERMINE APPROVER -->
    <workflowstate scriptid="workflowstate143" name="Determine Approver" position="643,193">
      <onentry>
        <!-- Set approval threshold -->
        <setfield field="custworkflow_tsc_emg008_approval_threshold" 
                 value="customrecord_tsc_approval_thresholds.val_106701_8172786_sb1_994"/>
        
        <!-- Retrieve approver configurations -->
        <customaction script="customscript_tsc_wa_emg008_retrieve_approvers" 
                     resultfield="custworkflow_tsc_emg008_ceo">
          <param name="approval_type" value="customlist_tsc_config_types.val_106601_8172786_sb1_316"/>
          <param name="approval_role" value="customlist_tsc_role_types.val_106607_8172786_sb1_898"/>
        </customaction>
        
        <customaction script="customscript_tsc_wa_emg008_retrieve_approvers" 
                     resultfield="custworkflow_tsc_emg008_cfo">
          <param name="approval_type" value="customlist_tsc_config_types.val_106601_8172786_sb1_316"/>
          <param name="approval_role" value="customlist_tsc_role_types.val_106606_8172786_sb1_593"/>
        </customaction>
        
        <customaction script="customscript_tsc_wa_emg008_retrieve_approvers" 
                     resultfield="custworkflow_tsc_emg008_coo">
          <param name="approval_type" value="customlist_tsc_config_types.val_106601_8172786_sb1_316"/>
          <param name="approval_role" value="customlist_tsc_role_types.val_106605_8172786_sb1_394"/>
        </customaction>
        
        <!-- Set approval status and clear delegate fields -->
        <setfield field="STDBODYAPPROVALSTATUS" value="1"/>
        <setfield field="custbody_tsc_is_delegate_active" value=""/>
        <setfield field="custbody_tsc_assigned_delegate_approv" value=""/>
      </onentry>
      <transitions>
        <!-- Route to appropriate approval level based on amount and user -->
        <transition to="workflowstate144" 
                   condition="Total >= Threshold.CompanyAutoApprovalLimit AND User NOT IN (COO,CFO,CEO)"/>
        <transition to="workflowstate146" 
                   condition="User IN COO AND Total >= Threshold.CompanyAutoApprovalLimit"/>
        <transition to="workflowstate145" 
                   condition="User IN CFO AND Total >= Threshold.COOApprovalLimit"/>
        <transition to="workflowstate147" trigger="AFTERSUBMIT"
                   condition="User IN CEO AND Total >= Threshold.CFOApprovalLimit"/>
        <transition to="workflowstate147" trigger="AFTERSUBMIT"
                   condition="Total < Threshold.CompanyAutoApprovalLimit"/>
      </transitions>
    </workflowstate>

    <!-- STATE 3: PENDING COO -->
    <workflowstate scriptid="workflowstate144" name="Pending COO" position="643,313">
      <customfields>
        <field scriptid="custwfstate_tsc_emg008_coo_delegate" type="SELECT" 
               selectrecordtype="customrecord_tsc_delegate_approvers" label="COO Delegate"/>
      </customfields>
      <onentry>
        <setfield field="STDBODYNEXTAPPROVER" value="COO.PrimaryApprover"/>
        <customaction script="customscript_tsc_wa_emg008_check_delegate" 
                     resultfield="custwfstate_tsc_emg008_coo_delegate">
          <param name="primary_approver" value="COO.PrimaryApprover"/>
        </customaction>
        <conditional condition="COODelegate IS NOT EMPTY">
          <setfield field="custbody_tsc_is_delegate_active" value="T"/>
          <setfield field="custbody_tsc_assigned_delegate_approv" value="COODelegate.DelegateApprover"/>
        </conditional>
      </onentry>
      <beforeload>
        <addbutton label="Approve" condition="User = COO.PrimaryApprover OR (DelegateActive = T AND User = AssignedDelegate)"/>
        <addbutton label="Reject" condition="User = COO.PrimaryApprover OR (DelegateActive = T AND User = AssignedDelegate)"/>
      </beforeload>
      <transitions>
        <transition to="workflowstate146" button="Approve"/>
        <transition to="workflowstate148" button="Reject"/>
      </transitions>
    </workflowstate>

    <!-- STATE 4: PENDING CFO -->
    <workflowstate scriptid="workflowstate146" name="Pending CFO" position="643,423">
      <customfields>
        <field scriptid="custwfstate_tsc_emg008_cfo_delegate" type="SELECT" 
               selectrecordtype="customrecord_tsc_delegate_approvers" label="CFO Delegate"/>
      </customfields>
      <onentry>
        <createrecord type="customrecord_tsc_approval_history" condition="User NOT IN CFO.PrimaryApprover">
          <field name="custrecord_tsc_transaction" value="@CURRENT@"/>
          <field name="custrecord_tsc_original_approver" value="COO.PrimaryApprover"/>
          <field name="custrecord_tsc_actual_approver" value="@CURRENTUSER@"/>
          <field name="custrecord_tsc_approval_action" value="Approved"/>
          <field name="custrecord_tsc_approval_date" value="TODAY"/>
        </createrecord>
        <setfield field="STDBODYNEXTAPPROVER" value="CFO.PrimaryApprover"/>
        <customaction script="customscript_tsc_wa_emg008_check_delegate" 
                     resultfield="custwfstate_tsc_emg008_cfo_delegate">
          <param name="primary_approver" value="CFO.PrimaryApprover"/>
        </customaction>
        <conditional condition="CFODelegate IS NOT EMPTY">
          <setfield field="custbody_tsc_is_delegate_active" value="T"/>
          <setfield field="custbody_tsc_assigned_delegate_approv" value="CFODelegate.DelegateApprover"/>
        </conditional>
      </onentry>
      <beforeload>
        <addbutton label="Approve" condition="User = CFO.PrimaryApprover OR (DelegateActive = T AND User = AssignedDelegate)"/>
        <addbutton label="Reject" condition="User = CFO.PrimaryApprover OR (DelegateActive = T AND User = AssignedDelegate)"/>
      </beforeload>
      <transitions>
        <transition to="workflowstate145" button="Approve" condition="Total > Threshold.CFOApprovalLimit"/>
        <transition to="workflowstate147" button="Approve" condition="Total <= Threshold.CFOApprovalLimit"/>
        <transition to="workflowstate148" button="Reject"/>
      </transitions>
    </workflowstate>

    <!-- STATE 5: PENDING CEO -->
    <workflowstate scriptid="workflowstate145" name="Pending CEO" position="643,523">
      <customfields>
        <field scriptid="custwfstate_tsc_emg008_ceo_delegate" type="SELECT" 
               selectrecordtype="customrecord_tsc_delegate_approvers" label="CEO Delegate"/>
      </customfields>
      <onentry>
        <createrecord type="customrecord_tsc_approval_history" condition="User NOT IN CFO.PrimaryApprover">
          <field name="custrecord_tsc_transaction" value="@CURRENT@"/>
          <field name="custrecord_tsc_original_approver" value="CFO.PrimaryApprover"/>
          <field name="custrecord_tsc_actual_approver" value="@CURRENTUSER@"/>
          <field name="custrecord_tsc_approval_action" value="Approved"/>
          <field name="custrecord_tsc_approval_date" value="TODAY"/>
        </createrecord>
        <setfield field="STDBODYNEXTAPPROVER" value="CEO.PrimaryApprover"/>
        <customaction script="customscript_tsc_wa_emg008_check_delegate" 
                     resultfield="custwfstate_tsc_emg008_ceo_delegate">
          <param name="primary_approver" value="CEO.PrimaryApprover"/>
        </customaction>
        <conditional condition="CEODelegate IS NOT EMPTY">
          <setfield field="custbody_tsc_is_delegate_active" value="T"/>
          <setfield field="custbody_tsc_assigned_delegate_approv" value="CEODelegate.DelegateApprover"/>
        </conditional>
      </onentry>
      <beforeload>
        <addbutton label="Approve" condition="User = CEO.PrimaryApprover OR (DelegateActive = T AND User = AssignedDelegate)"/>
        <addbutton label="Reject" condition="User = CEO.PrimaryApprover OR (DelegateActive = T AND User = AssignedDelegate)"/>
      </beforeload>
      <transitions>
        <transition to="workflowstate147" button="Approve"/>
        <transition to="workflowstate148" button="Reject"/>
      </transitions>
    </workflowstate>

    <!-- STATE 6: APPROVED -->
    <workflowstate scriptid="workflowstate147" name="Approved" position="193,263">
      <onentry>
        <createrecord type="customrecord_tsc_approval_history" condition="NextApprover IS NOT EMPTY">
          <field name="custrecord_tsc_transaction" value="@CURRENT@"/>
          <field name="custrecord_tsc_original_approver" value="STDBODYNEXTAPPROVER"/>
          <field name="custrecord_tsc_actual_approver" value="@CURRENTUSER@"/>
          <field name="custrecord_tsc_approval_action" value="Approved"/>
          <field name="custrecord_tsc_approval_date" value="TODAY"/>
        </createrecord>
        <sendemail recipient="custbody_tsc_created_by" sender="STDBODYNEXTAPPROVER" 
                  subject="Request Approved PO {tranid}" includetransaction="T" 
                  condition="NextApprover IS NOT EMPTY"/>
        <setfield field="STDBODYAPPROVALSTATUS" value="2"/>
        <setfield field="STDBODYNEXTAPPROVER" value=""/>
        <setfield field="custbody_tsc_is_delegate_active" value=""/>
        <setfield field="custbody_tsc_assigned_delegate_approv" value=""/>
      </onentry>
      <transitions>
        <transition to="workflowstate142" trigger="BEFORESUBMIT" 
                   condition="Total != OldRecord.Total"/>
      </transitions>
    </workflowstate>

    <!-- STATE 7: REJECTED -->
    <workflowstate scriptid="workflowstate148" name="Rejected" position="933,313" donotexitworkflow="T">
      <onentry>
        <createrecord type="customrecord_tsc_approval_history" condition="NextApprover IS NOT EMPTY">
          <field name="custrecord_tsc_transaction" value="@CURRENT@"/>
          <field name="custrecord_tsc_original_approver" value="STDBODYNEXTAPPROVER"/>
          <field name="custrecord_tsc_actual_approver" value="@CURRENTUSER@"/>
          <field name="custrecord_tsc_approval_action" value="Rejected"/>
          <field name="custrecord_tsc_approval_date" value="TODAY"/>
        </createrecord>
        <sendemail recipient="custbody_tsc_created_by" sender="STDBODYNEXTAPPROVER" 
                  subject="Request Rejected PO{tranid}" includetransaction="T" 
                  condition="NextApprover IS NOT EMPTY"/>
        <setfield field="STDBODYAPPROVALSTATUS" value="3"/>
        <setfield field="STDBODYNEXTAPPROVER" value=""/>
        <setfield field="custbody_tsc_is_delegate_active" value=""/>
        <setfield field="custbody_tsc_assigned_delegate_approv" value=""/>
      </onentry>
    </workflowstate>

  </workflowstates>
</workflow>

<!-- 
WORKFLOW LOGIC SUMMARY:
1. INITIATE: Set created by user, disable fields
2. DETERMINE APPROVER: Retrieve approver configs, route based on amount/user
3. PENDING COO: Check delegates, show approve/reject buttons
4. PENDING CFO: Log COO approval, check CFO delegates, route based on amount
5. PENDING CEO: Log CFO approval, check CEO delegates  
6. APPROVED: Log final approval, send email, clear fields
7. REJECTED: Log rejection, send email, clear fields

KEY FEATURES PRESERVED:
- Hierarchical approval (COO -> CFO -> CEO)
- Amount-based routing
- Delegate support with active checking
- Approval history logging
- Email notifications
- Field management and display control
- Re-initiation on total change
-->